# Документация по проекту niNE

Этот документ представляет технический обзор архитектуры проекта niNE, его ключевых компонентов и потоков данных.

---

## Ключевая архитектура

Проект использует гибридную архитектуру, сочетающую **Panda3D** для 3D-рендеринга и его менеджер задач с **asyncio** из Python для современной, высокопроизводительной сетевой части.

-   **Менеджер задач Panda3D** используется для основного игрового цикла (`game_loop` на сервере, `update_movement_task` на клиенте), симуляции физики и других покадровых обновлений.
-   **Asyncio** используется для всей сетевой коммуникации, что позволяет серверу эффективно обрабатывать множество одновременных клиентов и обеспечивает неблокирующие сетевые вызовы на стороне клиента.
-   Обе системы интегрированы через специальную задачу (`poll_asyncio`), которая выполняет одну итерацию цикла событий asyncio в рамках игрового цикла Panda3D.

---

## Клиент-серверное взаимодействие

Взаимодействие осуществляется по собственному, зашифрованному с помощью SSL, протоколу на основе JSON.

-   **Транспорт:** Все общение происходит по одному TCP-сокету, защищенному с помощью SSL/TLS. Сервер использует самоподписанный сертификат (`certs/cert.pem` и `certs/key.pem`), который клиент должен иметь для проверки соединения.
-   **Протокол сообщений:** Сообщения отправляются в виде JSON-строк. Для обработки кадрирования сообщений (т.е. чтобы знать, где заканчивается одно сообщение и начинается другое), перед каждой JSON-полезной нагрузкой добавляется 4-байтовый заголовок, содержащий длину этой нагрузки в виде беззнакового целого числа.
-   **Централизованная логика:** Основная логика для отправки и получения этих сообщений с префиксом длины централизована в модуле `nine.core.network`, который используется всеми клиентами.

---

## Сервер (`GameServer`)

**Файл:** `nine/server/game_server.py`

Сервер является авторитетным источником истины для игрового мира. Он управляет состоянием игры, физикой и всеми взаимодействиями с клиентами.

-   **Обязанности:**
    -   Принятие и управление клиентскими подключениями.
    -   Обработка входящих сообщений (аутентификация, ввод и т.д.).
    -   Выполнение основного игрового цикла (`game_loop`) с фиксированной частотой (`tick_rate`).
    -   Симуляция физического мира (`BulletWorld`).
    -   Рассылка состояния мира всем клиентам.
-   **Аутентификация:**
    -   **`auth`:** Стандартная аутентификация для обычных клиентов. Сервер предотвращает вход нескольких клиентов под одним и тем же именем.
    -   **`dev_auth`:** Специальный путь аутентификации для клиентов разработки. Если в `server_config.json` установлено `allow_dev_client: true`, сервер обходит проверку на уникальность имени, позволяя подключаться нескольким dev-клиентам для тестирования.

---

## Клиенты

### 1. Основной игровой клиент (`client.py`)

Это основной клиент, с которым взаимодействует пользователь.

-   **Класс:** `GameClient`
-   **Функциональность:**
    -   Предоставляет полный пользовательский интерфейс (главное меню, экран входа, настройки и т.д.), управляемый `UIManager`.
    -   В стандартном режиме действует как "глупый" клиент: он захватывает необработанный ввод с клавиатуры (`w`, `a`, `s`, `d`) и отправляет его на сервер через сообщение `input`. Затем сервер симулирует движение и отправляет новую позицию обратно в широковещательном сообщении `world_state`.
    -   **Режим разработки:** Может быть запущен в режиме разработки с помощью флага `--dev`. В этом режиме он ведет себя аналогично `DevGameClient`.

### 2. Клиент для разработки (`dev_client.py`)

Это отдельный, упрощенный клиент для быстрой разработки и тестирования.

-   **Класс:** `DevGameClient`
-   **Функциональность:**
    -   Не имеет главного меню; он автоматически подключается к указанному хосту/порту при запуске.
    -   Всегда использует `dev_auth`.
    -   Использует **предсказание на стороне клиента (client-side prediction)**. Он самостоятельно рассчитывает свое движение на основе ввода игрока каждый кадр и отправляет итоговую позицию на сервер через сообщение `move`. Это обеспечивает более плавный игровой процесс для локального игрока, но делает клиента авторитетным в отношении его собственной позиции. Сервер просто принимает эту позицию и рассылает ее другим клиентам.

---

## Система плагинов (`PluginManager`)

**Файл:** `nine/core/plugins.py`

Проект обладает мощной, событийно-ориентированной системой плагинов, которая позволяет модульно и независимо разрабатывать новый функционал.

-   **Обнаружение:** `PluginManager` автоматически находит и загружает Python-файлы и пакеты из каталога `nine/plugins/`.
-   **Фильтрация:** Каждый класс плагина может иметь атрибут `plugin_type`, который может быть `'client'`, `'server'` или `'common'`. Менеджер загрузит только те плагины, которые соответствуют текущему окружению (например, он не будет загружать плагин типа `'client'` на сервере).
-   **Слабая связанность:** Плагины не ссылаются напрямую на основное приложение или другие компоненты. Вместо этого они общаются с помощью `EventManager`.
    -   **Подписка:** Плагин может `subscribe` на события (например, на тип сетевого сообщения, такой как `"chat_broadcast"`, или на событие UI, такое как `"escape_key_pressed"`).
    -   **Публикация:** Плагин может `post` собственные события, чтобы инициировать действия в основных системах или других плагинах (например, опубликовать `"client_send_chat_message"`, чтобы клиент отправил сетевой пакет).
-   **Пример:** Плагин `chat_ui.py` слушает сетевое событие `"chat_broadcast"` для отображения сообщений и публикует событие `"client_send_chat_message"`, когда пользователь вводит текст.

---

## Система UI (`UIManager`)

**Файл:** `nine/ui/manager.py`

Пользовательский интерфейс управляется центральным `UIManager`, который действует как конечный автомат, контролируя, какой экран активен в данный момент.

-   **Базовый компонент:** Все экраны UI (например, `MainMenu`, `LoginMenu`) наследуются от `BaseUIComponent`, что обеспечивает у них единый интерфейс (`show`, `hide`, `destroy`) и гарантирует, что все элементы DirectGUI будут корректно очищены для предотвращения утечек памяти.
-   **Коллбэки:** `UIManager` инициализируется словарем коллбэков, что позволяет компонентам UI инициировать действия в основном классе клиента (например, `attempt_login`, `exit_game`), не будучи напрямую связанными с ним.

---

## Конфигурация

Проект использует четкое разделение между конфигурацией клиента и сервера.

-   **`config.json`:** Содержит настройки на стороне клиента, такие как никнейм, разрешение и чувствительность камеры. Его читают только клиенты.
-   **`server_config.json`:** Содержит настройки на стороне сервера, такие как хост, порт, частота тиков и флаг `allow_dev_client`. **Этот файл никогда не должен читаться клиентом.** Это разделение было ключевой частью недавнего архитектурного рефакторинга.