# Документация по Проекту "niNE"

Этот документ содержит техническую документацию по ключевым классам и методам проекта.

---

## `ServerApp`
**Файл:** `server.py`

Основной класс серверного приложения. Управляет жизненным циклом сервера, подключениями клиентов, игровым состоянием и глобальными серверными системами.

### `__init__(self)`
- **Назначение:** Инициализирует сервер.
- **Действия:**
    - Загружает конфигурацию из `server_config.json`.
    - Инициализирует логгер для записи в `server.log`.
    - Создает экземпляры `NetworkManager`, `DatabaseManager` и `PluginManager`.
    - Устанавливает обработчики для основных сетевых событий (подключение, отключение, получение сообщения).

### `on_client_connected(self, event: ClientConnectedEvent)`
- **Назначение:** Обработчик события подключения нового клиента.
- **Аргументы:**
    - `event`: Объект события, содержащий `client_id`.
- **Действия:** Выводит в консоль сообщение о том, что клиент ожидает аутентификации.

### `on_client_disconnected(self, event: ClientDisconnectedEvent)`
- **Назна-чение:** Обработчик события отключения клиента.
- **Аргументы:**
    - `event`: Объект события, содержащий `client_id`.
- **Действия:**
    - Сохраняет позицию и имя игрока в базу данных (если это не dev-клиент).
    - Удаляет игрока из активного списка `self.players`.
    - Рассылает всем остальным клиентам сообщение `player_left`, чтобы они удалили модель персонажа из своего мира.

### `on_message_received(self, event: MessageReceivedEvent)`
- **Назначение:** Центральный обработчик входящих сообщений от клиентов.
- **Аргументы:**
    - `event`: Объект события, содержащий `client_id` и `data` (полезная нагрузка сообщения).
- **Действия:**
    - **`auth` / `dev_auth`**: Обрабатывает логику аутентификации или "быстрого входа" для разработки. При успехе создает игрока в мире и отправляет ему приветственное сообщение `welcome` со всей нужной информацией.
    - **`move`**: Получает от клиента новые данные о его позиции и вращении. Обновляет состояние этого игрока в `self.players`. Эти данные затем рассылаются всем в `broadcast_world_state`.
    - **Другие типы**: Передает сообщения другим системам через `EventManager` (например, для чата).

### `async broadcast_world_state(self)`
- **Назна-чение:** Основной цикл синхронизации состояния мира.
- **Действия:**
    - С заданной частотой (`tick_rate`) собирает данные обо всех игроках (`self.players`).
    - Рассылает широковещательное сообщение `world_state` всем подключенным клиентам.

---

## `GameClient`
**Файлы:** `client.py`, `dev_client.py`

Основной класс клиентского приложения. Управляет окном игры, вводом, рендерингом, подключением к серверу и локальным представлением игрового мира.

### `__init__(self, ...)`
- **Назначение:** Инициализирует клиент.
- **Действия:**
    - Загружает конфигурации из `config.json` и `server_config.json`.
    - Инициализирует логгер, `PluginManager`, `UIManager` и `CameraController`.
    - Устанавливает обработчики ввода с клавиатуры (`w`, `a`, `s`, `d`, `escape`).
    - Запускает процесс подключения к серверу.

### `game_update(self, task)` / `update_movement(self, task)`
- **Назначение:** Главный игровой цикл на клиенте, выполняется каждый кадр.
- **Действия:**
    - Определяет, нажал ли игрок клавиши движения.
    - Если да, вычисляет новый вектор движения на основе направления камеры.
    - Обновляет позицию и вращение локального игрока (`self.player_actor`).
    - Запускает анимацию ходьбы (`walk`) или простоя (`idle`).
    - Отправляет на сервер сообщение `move` с новой позицией и вращением.

### `handle_network_data(self, data: dict)`
- **Назначение:** Центральный обработчик входящих сообщений от сервера.
- **Аргументы:**
    - `data`: Словарь с данными сообщения.
- **Действия:**
    - **`welcome`**: Вызывается при успешном входе в мир. Создает локального игрока (`player_actor`), других игроков, которые уже есть на сервере, и инициализирует `CameraController`.
    - **`player_joined`**: Создает модель и анимации для нового игрока, подключившегося к серверу.
    - **`player_left`**: Удаляет модель игрока, отключившегося от сервера.
    - **`world_state`**: Принимает данные обо всех игроках. Обновляет позицию, вращение и анимацию для всех *других* игроков в мире.
    - **`chat_broadcast`**: Отображает входящее сообщение чата в UI.

### `enable_game_input(self)` / `disable_game_input(self)`
- **Назначение:** Включает или отключает "игровой режим" управления.
- **Действия:**
    - Вызывает `self.camera_controller.start()` или `self.camera_controller.stop()` для переключения режима мыши и активации/деактивации вращения камеры.
    - Включает/выключает игровой цикл `game_update`. Используется, когда нужно открыть меню или окно чата.

---

## `CameraController`
**Файл:** `nine/core/camera_controller.py`

Управляет камерой от третьего лица, ее вращением и следованием за персонажем.

### `__init__(self, base, camera, win, target, sensitivity)`
- **Назначение:** Инициализирует контроллер камеры.
- **Аргументы:**
    - `base`: Основной экземпляр приложения (`ShowBase`).
    - `camera`: Объект камеры Panda3D.
    - `win`: Игровое окно.
    - `target`: `NodePath` объекта, за которым камера должна следовать (персонаж игрока).
    - `sensitivity`: Множитель чувствительности мыши (из `config.json`).
- **Действия:**
    - Создает `camera_pivot` - невидимый узел, который будет вращаться и за которым будет следовать камера.
    - Устанавливает начальное расстояние и высоту камеры от цели.
    - Сохраняет множитель чувствительности.

### `start(self)` / `stop(self)`
- **Назначение:** Активирует и деактивирует управление камерой.
- **Действия:**
    - `start()`: Включает относительный режим мыши (`M_relative`) и скрывает курсор. Запускает задачу `_update`.
    - `stop()`: Возвращает абсолютный режим мыши (`M_absolute`) и показывает курсор. Останавливает задачу `_update`.

### `_update(self, task)`
- **Назна-чение:** Выполняется каждый кадр для обновления состояния камеры.
- **Действия:**
    - Перемещает `camera_pivot` точно в позицию цели (`target`).
    - Получает смещение мыши (`dx`, `dy`) с момента последнего кадра.
    - Вращает `camera_pivot` по горизонтали и вертикали на основе `dx`, `dy` и чувствительности.
    - Если система не поддерживает относительный режим мыши, эмулирует его, принудительно возвращая курсор в центр экрана после каждого кадра.

---

## `PluginManager`
**Файл:** `nine/core/plugins.py`

Отвечает за обнаружение, загрузку и выгрузку плагинов.

### `load_plugins(self, ...)`
- **Назначение:** Находит и загружает все плагины.
- **Действия:**
    - Сканирует директории (по умолчанию `nine/plugins`).
    - Для каждого найденного Python-файла или пакета вызывает внутренние методы загрузки.

### `_initialize_plugin_classes(self, module, path)`
- **Назначение:** Инициализирует классы плагинов из загруженного модуля.
- **Действия:**
    - Проверяет `plugin_type` класса плагина. Если тип не соответствует окружению (например, клиентский плагин на сервере), он пропускается.
    - Создает экземпляр класса плагина.
    - Вызывает метод `on_load()` плагина.

### `unload_plugins(self)`
- **Назначение:** Корректно выгружает все активные плагины.
- **Действия:**
    - Проходит по списку загруженных плагинов и вызывает у каждого метод `on_unload()`.

---

## `SettingsMenu`
**Файл:** `nine/ui/settings_menu.py`

Класс UI-компонента для меню настроек.

### `_setup(self)`
- **Назначение:** Создает все графические элементы меню.
- **Действия:**
    - Создает фрейм, заголовок, поля ввода и слайдеры с помощью `DirectGui`.
    - Загружает начальные значения для элементов из глобального объекта `config`.
    - Назначает команды (callback-функции) для кнопок и слайдера.

### `_on_sensitivity_changed(self)`
- **Назначение:** Callback, который вызывается в реальном времени при движении слайдера чувствительности.
- **Действия:**
    - Получает новое значение слайдера.
    - Обновляет текстовую метку, чтобы показать числовое значение.
    - Напрямую обновляет `sensitivity_multiplier` в активном `camera_controller`, чтобы изменения применялись мгновенно.

### `_on_save_click(self)`
- **Назначение:** Callback для кнопки "Save".
- **Действия:**
    - Получает значения из всех элементов UI (никнейм, разрешение, чувствительность).
    - Сохраняет эти значения в глобальный объект `config` (который затем запишет их в `config.json`).
    - Применяет некоторые настройки немедленно (например, разрешение окна).
    - Закрывает меню настроек.
